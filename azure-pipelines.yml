# azure-pipelines.yml - Complete CI/CD
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  dockerhubUsername: 'kavitharc'
  imageName: 'yamlpythonapp'
  tag: '$(Build.BuildId)'
  aksName: 'myAKSCluster'
  namespace: 'default'

stages:

# Stage 1: Build and Push
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: Build
    displayName: 'Build'
    steps:
    - task: Bash@3
      displayName: 'Create K8s Manifests'
      inputs:
        targetType: 'inline'
        script: |
          mkdir -p manifests
          cat > manifests/deployment.yaml << 'EOF'
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      imagePullSecrets:
      - name: dockerhub-secret
      containers:
      - name: myapp
        image: $(dockerhubUsername)/$(imageName):latest
        ports:
        - containerPort: 80
EOF
          cat > manifests/service.yaml << 'EOF'
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: myapp
EOF

    - task: Docker@2
      displayName: 'Login to Docker Hub'
      inputs:
        containerRegistry: 'docker-connection'
        command: 'login'

    - task: Docker@2
      displayName: 'Build and Push'
      inputs:
        command: 'buildAndPush'
        Dockerfile: '**/Dockerfile'
        tags: |
          $(dockerhubUsername)/$(imageName):$(tag)
          $(dockerhubUsername)/$(imageName):latest

    - task: PublishPipelineArtifact@1
      displayName: 'Publish Manifests'
      inputs:
        targetPath: 'manifests'
        artifact: 'manifests'

# Stage 2: Deploy
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  condition: succeeded()
  jobs:
  - job: Deploy
    displayName: 'Deploy'
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: 'Download Manifests'
      inputs:
        artifact: 'manifests'
        path: '$(System.DefaultWorkingDirectory)/manifests'

    - task: Bash@3
      displayName: 'Update Image Tag'
      inputs:
        targetType: 'inline'
        script: |
          sed -i 's|:latest|:$(Build.BuildId)|g' $(System.DefaultWorkingDirectory)/manifests/deployment.yaml

    - task: Kubernetes@1
      displayName: 'Set K8s Context'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscription: '8253847f-5312-4919-9455-413d8ccca66c'
        azureResourceGroup: 'NCPLindia'
        kubernetesCluster: '$(aksName)'
        command: 'set context'

    - task: Kubernetes@1
      displayName: 'Deploy to AKS'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscription: '8253847f-5312-4919-9455-413d8ccca66c'
        azureResourceGroup: 'NCPLindia'
        kubernetesCluster: '$(aksName)'
        command: 'apply'
        arguments: '-f $(System.DefaultWorkingDirectory)/manifests'
